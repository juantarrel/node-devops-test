# Docker
# Build a Docker image 
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build image
  jobs:  
  - job: Build
    displayName: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: CloudFormationCreateOrUpdateStack@1
      inputs:
        awsCredentials: 'Aws ambryhill test'
        regionName: 'us-east-1'
        stackName: 'stack-ah-prod-$(Build.BuildId)'
        templateSource: 's3'
        s3BucketName: 'ambryhill-cf'
        s3ObjectKey: 'prod-2020-05-27.json'
        templateParametersSource: 'inline'
        templateParameters: |
          -
            ParameterKey: 'AZs'
            ParameterValue: 'us-east-1d, us-east-1a'
          -
            ParameterKey: 'InstanceCount'
            ParameterValue: '2'
          -
            ParameterKey: 'Subnets'
            ParameterValue: 'subnet-09956b30369a7c713, subnet-0cf3a8c9703dc2ca3'
          -
            ParameterKey: 'VpcId'
            ParameterValue: 'vpc-02777bc8e193269b2'
          -
            ParameterKey: 'KeyName'
            ParameterValue: 'key_ambryhill_prod'
          -
            ParameterKey: 'InstanceType'
            ParameterValue: 't2.micro'
    - task: Docker@2
      inputs:
        repository: 'ahbase'
        command: 'build'
        Dockerfile: 'Dockerfile'
        arguments: '--build-arg APP_DOMAIN=PRODUCTION'
    - task: ECRPushImage@1
      inputs:
        awsCredentials: 'Aws ambryhill test'
        regionName: 'us-east-1'
        imageSource: 'imagename'
        sourceImageName: 'ah-base'
        repositoryName: 'prod-ambryhill-app'
    
